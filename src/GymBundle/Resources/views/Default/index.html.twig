<html>
<head>
    <title>Calendar</title>
    <meta charset="utf-8">
</head>
<body>
    <link rel='stylesheet' href='http://cdnjs.cloudflare.com/ajax/libs/fullcalendar/2.4.0/fullcalendar.min.css' />
    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css' />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.min.js'></script>
    <script src='http://cdnjs.cloudflare.com/ajax/libs/fullcalendar/2.4.0/fullcalendar.min.js'></script>
    <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js'></script>
    <div class="containe">
        <div id='calendar' class="col-lg-4"></div>
        <div class="col-sm-4">
            <h2>Workouts</h2>
            <div class="exercises">

            </div>

        </div>
    </div>



    <script>
        var workouts = [];
        {% for day in calendar %}
        var dayEvent = [];
        dayEvent['id'] = '{{ day.id }}'
        dayEvent['start'] = '{{ day.dateFormat }}';
        dayEvent['title'] = '{{ day.names }}';
        if (!dayEvent['title']) {
            dayEvent['title'] = 'workout';
        }
        workouts.push(dayEvent);
        {% endfor %}
//        console.log(workouts);
        $(document).ready(function() {
            $('#calendar').fullCalendar({
                events: workouts,
                eventClick: function(calEvent) {
                    $.ajax( "/app_dev.php/getWorkout/" + calEvent.id )
                        .done(function( json ) {
                            showExercise(json);
                        })
                        .fail(function( jqxhr, textStatus, error ) {
                            alert('Lohhhh!');
                        });
                }
            })
        });

        function showExercise(response) {
            console.log(response);
            $('.exercises').text("");
            $.each(response, function( index, exercise ) {
                        var     exe = $('<div id="' + exercise.id + '"></div>').append($('<h3></h3>').text(exercise.name));
                        exe.append(getSets(exercise.sets));
                        $('.exercises').append(exe);
                    }
            )
        }

        function getSets(sets) {
            var keys = [],
                    table = $('<table class="table"><thead></thead><tbody></tbody></table>');
                    thead = table.find('thead');
                    thead.append($('<th>Мера</th>'));
                    var it = 1;
            $.each(sets, function( i, rep ) {
                        if (keys.length === 0) {
                            keys = $.map(rep, function(element,index) {return index});
                        }
                        // Fix attr throught bootstrap
                        thead.append($('<th></th>').text(it).attr('align', 'center'))
                        $.each(keys, function(j, key) {
                          var tr = table.find('tbody').find('#'+key);
                          if (tr.length === 0) {
                              table.find('tbody').append($('<tr id="' + key + '"></tr>'))
                              tr = table.find('tbody').find('#'+key);
                              tr.append($('<td></td>').text(key));
                          }
                          // Fix attr throught bootstrap
                          tr.append($('<td></td>').text(rep[key]).attr('id', i).attr('align', 'center'));
                          table.find('tbody').append(tr);
                        });
                        it++;
                    });
            return table;
        }

    </script>


</body>
</html>
